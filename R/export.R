#' export
#'
#' Export andromeda generated by \link[TreatmentPatterns]{computePathways}
#' object to sharable csv-files and/or a zip archive.
#'
#' @export
#'
#' @template param_andromeda
#' @template param_outputPath
#' @template param_ageWindow
#' @template param_minFreq
#' @template param_archiveName
#'
#' @return (`invisible(NULL)`)
#'
#' @examples
#' if (FALSE) {
#'   andromeda <- computePathways(
#'     cohorts,
#'     cohortTableName,
#'     cdm
#'   )
#'
#'   export(
#'     andromeda,
#'     outputPath = "./",
#'     ageWindow = 10,
#'     minFreq = 5,
#'     archiveName = "output.zip"
#'   )
#' }
export <- function(andromeda, outputPath = ".", ageWindow = 10, minFreq = 5, archiveName = NULL) {
  if (!file.exists(outputPath)) {
    dir.create(outputPath)
  }

  treatmentHistory <- andromeda$treatmentHistory %>% dplyr::collect()

  # metadata
  metadataPath <- file.path(outputPath, "metadata.csv")
  message(sprintf("Writing metadata to %s", metadataPath))
  metadata <- andromeda$metadata %>% dplyr::collect()
  write.csv(metadata, file = metadataPath, row.names = FALSE)

  # Treatment Pathways
  treatmentPathwaysPath <- file.path(outputPath, "treatmentPathways.csv")
  message(sprintf("Writing treatmentPathways to %s", treatmentPathwaysPath))
  treatmentPathways <- computeTreatmentPathways(treatmentHistory, ageWindow, minFreq)

  nTotal <- andromeda$currentCohorts %>%
    dplyr::summarise(n = dplyr::n_distinct(.data$person_id)) %>%
    dplyr::pull()

  nTreated <- treatmentHistory %>%
    dplyr::summarise(n = dplyr::n_distinct(.data$person_id)) %>%
    dplyr::pull()

  treatmentPathways <- treatmentPathways %>%
    dplyr::add_row(data.frame(
      path = "None",
      freq = nTotal - nTreated,
      sex = "all",
      age = "all",
      index_year = "all"
    ))

  write.csv(treatmentPathways, file = treatmentPathwaysPath, row.names = FALSE)

  # Summary statistics duration
  statsTherapyPath <- file.path(outputPath, "summaryStatsTherapyDuraion.csv")
  message(sprintf("Writing summaryStatsTherapyDuraion to %s", statsTherapyPath))
  statsTherapy <- computeStatsTherapy(treatmentHistory)
  write.csv(statsTherapy, file = statsTherapyPath, row.names = FALSE)

  # Counts
  counts <- computeCounts(treatmentHistory, minFreq)

  countsYearPath <- file.path(outputPath, "countsYear.csv")
  message(sprintf("Writing countsYearPath to %s", countsYearPath))
  write.csv(counts$year, file = countsYearPath, row.names = FALSE)

  countsAgePath <- file.path(outputPath, "countsAge.csv")
  message(sprintf("Writing countsAgePath to %s", countsAgePath))
  write.csv(counts$age, file = countsAgePath, row.names = FALSE)

  countsSexPath <- file.path(outputPath, "countsSex.csv")
  message(sprintf("Writing countsSexPath to %s", countsSexPath))
  write.csv(counts$sex, file = countsSexPath, row.names = FALSE)

  if (!is.null(archiveName)) {
    zipPath <- file.path(outputPath, archiveName)

    message(sprintf("Zipping files to %s", zipPath))

    utils::zip(
      zipfile = zipPath,
      files = c(
        treatmentPathwaysPath, countsYearPath, countsAgePath, countsSexPath,
        statsTherapyPath
      )
    )
  }
  return(invisible(NULL))
}

#' computeStatsTherapy
#'
#' @template param_treatmentHistory
#'
#' @return (`data.frame()`)
computeStatsTherapy <- function(treatmentHistory) {
  stats <- treatmentHistory %>%
    mutate(treatmentType = dplyr::case_when(
      nchar(.data$event_cohort_id) > 1 ~ "combination",
      .default = "monotherapy"
    )) %>%
    group_by(.data$treatmentType) %>%
    summarise(
      avgDuration = mean(.data$duration_era),
      medianDuration = stats::median(.data$duration_era),
      sd = stats::sd(.data$duration_era),
      min = min(.data$duration_era),
      max = max(.data$duration_era),
      count = n()
    )

  return(stats)
}

#' computeCounts
#'
#' @template param_treatmentHistory
#' @template param_minFreq
#'
#' @return (`list()`)
computeCounts <- function(treatmentHistory, minFreq) {
  # n per Year
  countYear <- treatmentHistory %>%
    dplyr::group_by(.data$index_year) %>%
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::mutate(n = case_when(
      .data$n < minFreq ~ glue::glue("<{minFreq}"),
      .default = as.character(.data$n)
    ))

  # n per sex
  countSex <- treatmentHistory %>%
    dplyr::group_by(.data$sex) %>%
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::mutate(n = case_when(
      .data$n < minFreq ~ glue::glue("<{minFreq}"),
      .default = as.character(.data$n)
    ))

  # n per age
  countAge <- treatmentHistory %>%
    group_by(.data$age) %>%
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::mutate(n = case_when(
      .data$n < minFreq ~ glue::glue("<{minFreq}"),
      .default = as.character(.data$n)
    ))

  return(list(year = countYear, age = countAge, sex = countSex))
}


#' computeTreatmentPathways
#'
#' @template param_treatmentHistory
#' @template param_ageWindow
#' @template param_minFreq
#'
#' @return (`data.frame()`)
computeTreatmentPathways <- function(treatmentHistory, ageWindow, minFreq) {
  years <- c("all", treatmentHistory$index_year %>% unique())

  treatmentHistory <- treatmentHistory %>%
    rowwise() %>%
    dplyr::mutate(
      age_bin = paste(
        unlist(stringr::str_extract_all(as.character(cut(.data$age, seq(0, 150, ageWindow))), "\\d+")),
        collapse = "-"
      )
    )

  ages <- treatmentHistory$age_bin %>% unique()

  # Per year
  treatmentPathways <- stratisfy(treatmentHistory, years, ages)

  treatmentPathways <- treatmentPathways %>%
    mutate(index_year = as.character(.data$index_year))

  treatmentPathways[is.na(treatmentPathways)] <- "all"

  a <- nrow(treatmentPathways)

  treatmentPathways <- treatmentPathways %>%
    dplyr::filter(.data$freq >= minFreq)
  b <- nrow(treatmentPathways)

  message(sprintf("Removed %s pathways with a frequency < %s.", a - b, minFreq))
  return(treatmentPathways)
}

#' stratisfy
#'
#' @template param_treatmentHistory
#' @param years (`vector("character")`)
#' @param ages (`vector("character")`)
#'
#' @return (`data.frame()`)
stratisfy <- function(treatmentHistory, years, ages) {
  outDf <- dplyr::bind_rows(lapply(years, function(y) {
    all <- prepData(treatmentHistory = treatmentHistory, year = y)

    sex <- dplyr::bind_rows(
      treatmentHistory %>%
        filter(.data$sex == "MALE") %>%
        prepData(y) %>%
        mutate(sex = "male"),
      treatmentHistory %>%
        filter(.data$sex == "FEMALE") %>%
        prepData(y) %>%
        mutate(sex = "female")
    )

    age <- dplyr::bind_rows(lapply(ages, function(ageRange) {
      treatmentHistory %>%
        filter(.data$age_bin == ageRange) %>%
        prepData(y) %>%
        mutate(age = ageRange)
    }))

    return(dplyr::bind_rows(all, sex, age))
  }))
  return(outDf)
}
