---
title: "Running TreatmentPatterns"
always_allow_html: yes
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  html_vignette:
    toc: yes
    toc_depth: 3
    vignette: >
      %\VignetteIndexEntry{RunningTreatmentPatterns}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r sourceCG, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
source(system.file(package = "TreatmentPatterns", "R-scripts", "runCG.R"))
```

```{r libs, message=FALSE, warning=FALSE}
library(dplyr)
```

```{r setupCohorts}
# Select Viral Sinusitis Cohort
targetCohorts <- cohortsGenerated %>%
  filter(cohortName == "ViralSinusitis") %>%
  select(cohortId, cohortName)

# Select everything BUT Viral Sinusitis cohorts
eventCohorts <- cohortsGenerated %>%
  filter(cohortName != "ViralSinusitis" & cohortName != "Death") %>%
  select(cohortId, cohortName)

exitCohorts <- cohortsGenerated %>%
  filter(cohortName == "Death") %>%
  select(cohortId, cohortName)

cohorts <- dplyr::bind_rows(
  targetCohorts %>% mutate(type = "target"),
  eventCohorts %>% mutate(type = "event"),
  exitCohorts %>% mutate(type = "exit")
)
```

## DatabaseConnector
### All-in-one
```{r warning=FALSE, eval=FALSE}
tempDir <- tempdir()
allDir <- file.path(tempDir, "all_in_one")

TreatmentPatterns::executeTreatmentPatterns(
  cohorts = cohorts,
  cohortTableName = "CohortTable",
  outputPath = allDir,
  connectionDetails = connectionDetails,
  cdmSchema = "main",
  resultSchema = "main", 
  # Optional settings
  includeTreatments = "startDate",
  periodPriorToIndex = 0,
  minEraDuration = 0,
  splitEventCohorts = "",
  splitTime = 30,
  eraCollapseSize = 30,
  combinationWindow = 30,
  minPostCombinationDuration = 30,
  filterTreatments = "First",
  maxPathLength = 5
)
```
### Segmented
The segmented approach allows you to investigate the patient-level intermediate files by querying the andromeda environment.
```{r message=FALSE, warning=FALSE, results='hide'}
andromeda <- TreatmentPatterns::computePathways(
  cohorts = cohorts,
  cohortTableName = "CohortTable",
  connectionDetails = connectionDetails,
  cdmSchema = "main",
  resultSchema = "main"
)
```

```{r intermediateResults}
names(andromeda)
```

```{r treatmentHistory}
andromeda$treatmentHistory
```

The files inside the andromeda environment can be exported using the export function.
```{r message=FALSE, warning=FALSE, results='hide', eval=FALSE}
segDir <- file.path(tempDir, "segmented")
TreatmentPatterns::export(andromeda, outputPath = segDir)
```

## CDMConnector
```{r eval=FALSE}
cdmDir <- file.path(tempDir, "CDMCon")

con <- DBI::dbConnect(duckdb::duckdb(), eunomia_dir())
cdm <- CDMConnector::cdm_from_con(
  con = con,
  cdm_schema = "main",
  write_schema = "main"
)

TreatmentPatterns::executeTreatmentPatterns(
  cohorts = cohorts,
  cohortTableName = "CohortTable",
  outputPath = cdmDir,
  cdm = cdm)
```
