---
title: "Computing Treatment Pathways"
always_allow_html: yes
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  html_vignette:
    toc: yes
    toc_depth: 3
    vignette: >
      %\VignetteIndexEntry{ComputingTreatmentPathways}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

withr::local_envvar(
  R_USER_CACHE_DIR = tempfile(),
  EUNOMIA_DATA_FOLDER = Sys.getenv("EUNOMIA_DATA_FOLDER", unset = tempfile())
)
```

In **1. Defining Cohorts** we discussed how to define and generate cohorts for `TreatmentPatterns`. In this section we assume you are able to generate a cohort table using either `CohortGenerator` or `CDMConnector`.

Lets generate our Viral Sinusitis dummy cohorts provided in `TreatmentPatterns` using `CDMConnector`.

## Generating Cohorts
First we need to read in our cohorts.
```{r readCohortSet}
library(CDMConnector)

cohortSet <- readCohortSet(
  path = system.file(package = "TreatmentPatterns", "exampleCohorts")
)

cohortSet
```

Then we can open a connection to our database, in this case Eunomia.
```{r setLocalEnvar, echo=FALSE}
# withr::local_envvar(
#   R_USER_CACHE_DIR = tempfile(),
#   .local_envir = testthat::teardown_env(),
#   EUNOMIA_DATA_FOLDER = Sys.getenv("EUNOMIA_DATA_FOLDER", unset = tempfile())
# )

if (require("Eunomia", character.only = TRUE, quietly = TRUE)) {
  CDMConnector::downloadEunomiaData(overwrite = TRUE)
}
```

```{r connectToCDM}
con <- DBI::dbConnect(
  drv = duckdb::duckdb(),
  dbdir = eunomiaDir()
)

cdm <- cdmFromCon(
  con = con,
  cdmSchema = "main",
  writeSchema = "main"
)
cdm
```

Finally we can generate our cohort set as a cohort table into the database
```{r generateCohortSet}
cdm <- generateCohortSet(
  cdm = cdm,
  cohortSet = cohortSet,
  name = "cohort_table",
  overwrite = TRUE
)

cohortCount(cdm$cohort_table)
```

We can see that all our cohorts are generated in the cohort table. The cohort with _cohort_definition_id_ 5 has a count of 0, this is the _Death_ cohort. This is not detrimental, as exit cohorts are optional, but good to know that Death will not show up in our results.

## Computing pathways
The `computePathways` function of `TreatmentPatterns` allows us to compute treatment pathways in our cohort table. In order to do this we need to pre-specify some parameters.

According to the documentation we need a `data.frame` that specifies what cohort is of which type.

>Data frame containing the following columns and data types:
>
>cohortId numeric(1)
>Cohort ID's of the cohorts to be used in the cohort table.
>
>cohortName character(1)
>Cohort names of the cohorts to be used in the cohort table.
>
>type character(1) ["target", "event', "exit"]
>Cohort type, describing if the cohort is a target, event, or exit cohort

We are able to re-use our `cohortSet` for this. As it already contains the cohort ID's and cohort names. We only have to remove the `cohort` and `json` columns, add a `type` column, and rename `cohort_definition_id` to `cohortId` and `cohort_name` to `cohortName`.
```{r, message=FALSE}
library(dplyr)

cohorts <- cohortSet %>%
  # Remove 'cohort' and 'json' columns
  select(-"cohort", -"json", -"cohort_name_snakecase") %>%
  mutate(type = c("event", "event", "event", "event", "exit", "event", "event", "target")) %>%
  rename(
    cohortId = "cohort_definition_id",
    cohortName = "cohort_name",
  )

cohorts
```

With our `data.frame` of cohort types, CDM reference, and the cohort table name in our database we can compute the treatment pathways, with all of the other settings as their defaults.
```{r computeWithDefaults}
library(TreatmentPatterns)

defaultSettings <- computePathways(
  cohorts = cohorts,
  cohortTableName = "cohort_table",
  cdm = cdm
)

defaultSettings
```
The output of `computePathways` is an [Andromeda](https://ohdsi.github.io/Andromeda/) environment, which allows us to investigate intermediate results and patient-level data. **This data is not sharable.**

```{r outputTables}
# treatmentHistory table
head(defaultSettings$treatmentHistory)

# metadata table
defaultSettings$metadata

# First Recieved First Stopped
head(defaultSettings$addRowsFRFS_1)

# Last Recieved Last Stopped
head(defaultSettings$addRowsLRFS_1)
```
`DatabaseConnector` is also supported. The following parameters are required **instead** of `cdm`:

1. `connectionDetails`: ConnectionDetails object form [DatabaseConnector](https://ohdsi.github.io/DatabaseConnector/).
2. `cdmSchema`: Schema where the CDM exists.
3. `resultSchema`: Schema to write the cohort table to.
4. `tempEmulationSchema`: Some database platforms like Oracle and Impala do not truly support temp tables. To emulate temp tables, provide a schema with write privileges where temp tables can be created.
