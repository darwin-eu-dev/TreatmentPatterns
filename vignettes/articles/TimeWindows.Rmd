---
title: "Time Windows"
always_allow_html: yes
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  html_vignette:
    toc: yes
    toc_depth: 3
    vignette: >
      %\VignetteIndexEntry{Time Windows}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

withr::local_envvar(
  R_USER_CACHE_DIR = tempfile(),
  EUNOMIA_DATA_FOLDER = Sys.getenv("EUNOMIA_DATA_FOLDER", unset = tempfile())
)
```

## Time Windows in TreatmentPatterns
This vignette discusses how to dictate time windows for TreatmentPatterns.

## Anchoring
The `computePathways()` function has two 'anchor' arguments, `startAnchor` and `endAnchor`. These arguments dictate what point to use as a reference. The two values that you can set for both of these parameters are: `"startDate"` and `"endDate"`, referencing the `cohort_start_date` and `cohort_end_date` columns in the cohort table. By default they are set to: `startAnchor = "startDate"` and `endAnchor = "endDate"`

## windowStart and windowEnd
The `windowStart` and `windowEnd` parameters dictate an offset from their corresponding *anchor*. If we assuming the following parameters (defaults):

```
startAnchor = "startDate"
windowStart = 0
endAnchor = "endDate"
windowEnd = 0
```

We will just use the `cohort_start_date` and `cohort_end_date` as our window of interest.

We can extend our window with a 30 days on either side by altering the `windowStart` and `windowEnd` variables:

```
startAnchor = "startDate"
windowStart = -30
endAnchor = "endDate"
windowEnd = 30
```

Note that `windowStart = -30`, as in we subtract 30 days from the `startAnchor`. `windowEnd = 30` as in we add 30 days to the `endAnchor`.

## Changing the anchoring
We can change the anchoring of `startAnchor` and `endAnchor` to set our window to a period prior to the index date:

```
startAnchor = "startDate"
windowStart = -30
endAnchor = "startDate"
windowEnd = 0
```

Note that we set **both** the `startAnchor` and `endAnchor` are set to `"startDate"`. So we start -30 days from the index date, and end on the index date.

## Code examples
### Setup
```{r readCohortSet}
library(DBI)
library(duckdb)
library(CDMConnector)
library(TreatmentPatterns)

con <- DBI::dbConnect(duckdb::duckdb(), dbdir = eunomiaDir())
cdm <- cdmFromCon(con, cdmSchema = "main", writeSchema = "main")

cohortSet <- readCohortSet(
  path = system.file(package = "TreatmentPatterns", "exampleCohorts")
)

cdm <- generateCohortSet(
  cdm = cdm,
  cohortSet = cohortSet,
  name = "cohort_table"
)

cohorts <- cohortSet %>%
  # Remove 'cohort' and 'json' columns
  select(-"cohort", -"json") %>%
  mutate(type = c("event", "event", "event", "event", "exit", "event", "event", "target")) %>%
  rename(
    cohortId = "cohort_definition_id",
    cohortName = "cohort_name",
  ) %>%
  select("cohortId", "cohortName", "type")
```

### Default scenario
```{r}
outputEnv <- computePathways(
  cohorts = cohorts,
  cohortTableName = "cohort_table",
  cdm = cdm,
  startAnchor = "startDate",
  windowStart = 0,
  endAnchor = "endDate",
  windowEnd = 0
)
```

### Month prior
```{r}
outputEnv <- computePathways(
  cohorts = cohorts,
  cohortTableName = "cohort_table",
  cdm = cdm,
  startAnchor = "startDate",
  windowStart = -30,
  endAnchor = "startDate",
  windowEnd = -1
)
```

### Month after
```{r}
outputEnv <- computePathways(
  cohorts = cohorts,
  cohortTableName = "cohort_table",
  cdm = cdm,
  startAnchor = "endDate",
  windowStart = 1,
  endAnchor = "endDate",
  windowEnd = 30
)
```

### Month after start date, to month before end date
```{r}
outputEnv <- computePathways(
  cohorts = cohorts,
  cohortTableName = "cohort_table",
  cdm = cdm,
  startAnchor = "startDate",
  windowStart = 30,
  endAnchor = "endDate",
  windowEnd = -30
)
```
